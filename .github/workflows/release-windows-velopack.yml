name: Release Windows (Velopack)

on:
  push:
    branches: [main, live]
    paths:
      - "swifttunnel-windows/Cargo.toml"
      - ".github/workflows/release-windows-velopack.yml"
  workflow_dispatch:
    inputs:
      version:
        description: "Version to package (e.g. 1.0.42)"
        required: true
        default: "1.0.42"

permissions:
  contents: write

jobs:
  release-windows:
    name: Build & Publish (Windows Velopack)
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Install vpk CLI
        shell: pwsh
        run: |
          dotnet tool update -g vpk
          "$env:USERPROFILE\.dotnet\tools" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          vpk

      - name: Resolve version
        id: meta
        shell: pwsh
        run: |
          $version = ""
          if ("${{ github.event_name }}" -eq "workflow_dispatch") {
            $version = "${{ inputs.version }}"
          }

          if ([string]::IsNullOrWhiteSpace($version)) {
            $cargoToml = Get-Content "swifttunnel-windows/Cargo.toml" -Raw
            $match = [regex]::Match($cargoToml, '(?m)^version\s*=\s*"([^"]+)"')
            if (-not $match.Success) {
              throw "Could not resolve version from swifttunnel-windows/Cargo.toml"
            }
            $version = $match.Groups[1].Value
          }

          $version = $version.Trim().TrimStart("v")
          $tag = "v$version"
          "version=$version" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          "tag=$tag" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          Write-Host "Resolved version: $version"

      - name: Prepare packaging assets
        shell: pwsh
        run: |
          $projectRoot = "swifttunnel-windows"
          $distDir = Join-Path $projectRoot "dist"
          New-Item -ItemType Directory -Path $distDir -Force | Out-Null

          $iconCandidates = @(
            (Join-Path $projectRoot "dist\swifttunnel.ico"),
            (Join-Path $projectRoot "assets\swifttunnel.ico"),
            (Join-Path $projectRoot "installer\swifttunnel.ico")
          )
          $iconSource = $iconCandidates | Where-Object { Test-Path $_ } | Select-Object -First 1
          if (-not $iconSource) {
            throw "Could not find swifttunnel.ico in dist/, assets/, or installer/"
          }
          Copy-Item $iconSource (Join-Path $distDir "swifttunnel.ico") -Force

          $wintunTarget = Join-Path $distDir "wintun.dll"
          if (-not (Test-Path $wintunTarget)) {
            $wintunSource = Join-Path $projectRoot "drivers\wintun.dll"
            if (-not (Test-Path $wintunSource)) {
              throw "wintun.dll missing from dist/ and drivers/"
            }
            Copy-Item $wintunSource $wintunTarget -Force
          }

      - name: Build release binaries
        shell: pwsh
        run: |
          cargo build --release --target x86_64-pc-windows-msvc -p swifttunnel-fps-booster
          cargo build --release --target x86_64-pc-windows-msvc -p swifttunnel-fps-booster --bin driver-installer

      - name: Package with Velopack
        id: pack
        shell: pwsh
        env:
          VERSION: ${{ steps.meta.outputs.version }}
        run: |
          $releaseDir = "target\x86_64-pc-windows-msvc\release"
          $stagingDir = Join-Path $env:RUNNER_TEMP "velopack_staging"
          $outputDir = Join-Path $env:RUNNER_TEMP "velopack_output"

          if (Test-Path $stagingDir) { Remove-Item $stagingDir -Recurse -Force }
          if (Test-Path $outputDir) { Remove-Item $outputDir -Recurse -Force }
          New-Item -ItemType Directory -Path $stagingDir | Out-Null
          New-Item -ItemType Directory -Path (Join-Path $stagingDir "drivers") | Out-Null
          New-Item -ItemType Directory -Path $outputDir | Out-Null

          Copy-Item (Join-Path $releaseDir "swifttunnel-fps-booster.exe") (Join-Path $stagingDir "swifttunnel-fps-booster.exe") -Force
          if (Test-Path (Join-Path $releaseDir "driver-installer.exe")) {
            Copy-Item (Join-Path $releaseDir "driver-installer.exe") (Join-Path $stagingDir "driver-installer.exe") -Force
          }
          Copy-Item "swifttunnel-windows\dist\wintun.dll" (Join-Path $stagingDir "wintun.dll") -Force

          $driverMsi = Join-Path $stagingDir "drivers\WinpkFilter-x64.msi"
          Invoke-WebRequest `
            -Uri "https://github.com/wiresock/ndisapi/releases/download/v3.6.2/WinpkFilter-x64.msi" `
            -OutFile $driverMsi
          $driverSize = (Get-Item $driverMsi).Length
          if ($driverSize -lt 1000000) {
            throw "Downloaded WinpkFilter-x64.msi is suspiciously small ($driverSize bytes)"
          }

          vpk pack `
            -u SwiftTunnel `
            -v $env:VERSION `
            -p $stagingDir `
            -e swifttunnel-fps-booster.exe `
            --icon "swifttunnel-windows\dist\swifttunnel.ico" `
            -o $outputDir

          Write-Host "Generated Velopack files:"
          Get-ChildItem $outputDir -File | ForEach-Object {
            Write-Host "  $($_.Name)"
          }

          "output_dir=$outputDir" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

      - name: Ensure GitHub release exists
        shell: pwsh
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ steps.meta.outputs.tag }}
          VERSION: ${{ steps.meta.outputs.version }}
        run: |
          gh release view $env:TAG --repo $env:GITHUB_REPOSITORY *> $null
          if ($LASTEXITCODE -ne 0) {
            gh release create $env:TAG `
              --repo $env:GITHUB_REPOSITORY `
              --title "SwiftTunnel v$env:VERSION" `
              --notes "Automated Windows Velopack release assets." `
              --prerelease
          } else {
            Write-Host "Release $env:TAG already exists, will upload assets."
          }

      - name: Upload Velopack assets to release
        shell: pwsh
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ steps.meta.outputs.tag }}
          OUTPUT_DIR: ${{ steps.pack.outputs.output_dir }}
        run: |
          $files = Get-ChildItem $env:OUTPUT_DIR -File | ForEach-Object { $_.FullName }
          if (-not $files -or $files.Count -eq 0) {
            throw "No Velopack assets found in $env:OUTPUT_DIR"
          }
          gh release upload $env:TAG $files --clobber --repo $env:GITHUB_REPOSITORY
