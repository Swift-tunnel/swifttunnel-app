name: Release

on:
  push:
    branches: [main, live]
    paths:
      - "swifttunnel-desktop/**"
      - ".github/workflows/release.yml"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  release:
    name: Build & Publish (Tauri)
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: lts/*
          cache: npm
          cache-dependency-path: swifttunnel-desktop/package-lock.json

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install frontend dependencies
        working-directory: swifttunnel-desktop
        run: npm ci

      - name: Prepare bundled driver payloads
        shell: pwsh
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $driversDir = "swifttunnel-desktop/src-tauri/resources/drivers"
          New-Item -ItemType Directory -Path $driversDir -Force | Out-Null

          $msiPath = Join-Path $driversDir "WinpkFilter-x64.msi"
          if (-not (Test-Path $msiPath)) {
            gh release download v3.6.2 --repo wiresock/ndisapi --pattern "Windows.Packet.Filter.3.6.2.1.x64.msi" --dir $driversDir
            Rename-Item (Join-Path $driversDir "Windows.Packet.Filter.3.6.2.1.x64.msi") "WinpkFilter-x64.msi"
          }

          $size = (Get-Item $msiPath).Length
          if ($size -lt 500000) {
            throw "Downloaded WinpkFilter MSI is suspiciously small ($size bytes)"
          }

          echo "Bundled driver payloads:"
          Get-ChildItem $driversDir -File | ForEach-Object {
            echo "  $($_.Name) ($([math]::Round($_.Length / 1MB, 2)) MB)"
          }

      - name: Verify updater signing secrets
        shell: pwsh
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_UPDATER_PUBLIC_KEY: ${{ secrets.TAURI_UPDATER_PUBLIC_KEY }}
        run: |
          if ([string]::IsNullOrWhiteSpace($env:TAURI_SIGNING_PRIVATE_KEY)) {
            throw "Missing required secret: TAURI_SIGNING_PRIVATE_KEY"
          }
          if ([string]::IsNullOrWhiteSpace($env:TAURI_UPDATER_PUBLIC_KEY)) {
            throw "Missing required secret: TAURI_UPDATER_PUBLIC_KEY"
          }

      - name: Inject updater public key
        shell: pwsh
        env:
          TAURI_UPDATER_PUBLIC_KEY: ${{ secrets.TAURI_UPDATER_PUBLIC_KEY }}
        run: |
          $confPath = "swifttunnel-desktop/src-tauri/tauri.conf.json"
          $config = Get-Content $confPath -Raw | ConvertFrom-Json
          $config.plugins.updater.pubkey = $env:TAURI_UPDATER_PUBLIC_KEY
          $config | ConvertTo-Json -Depth 32 | Set-Content -Path $confPath -Encoding utf8

      - name: Build and publish release
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        with:
          projectPath: swifttunnel-desktop
          tagName: v__VERSION__
          releaseName: SwiftTunnel v__VERSION__
          releaseBody: See release assets to download this version.
          releaseDraft: false
          prerelease: false
          generateReleaseNotes: true
          includeUpdaterJson: true
          updaterJsonPreferNsis: true
