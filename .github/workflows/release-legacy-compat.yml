name: Release Legacy Compatibility (Velopack)

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Version to publish compatibility assets for (e.g. 1.0.43)"
        required: true
        default: "1.0.43"

permissions:
  contents: write

jobs:
  release-legacy-compat:
    name: Build & Upload Legacy Velopack Assets
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Install vpk CLI
        shell: pwsh
        run: |
          dotnet tool update -g vpk
          "$env:USERPROFILE\.dotnet\tools" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Resolve version
        id: meta
        shell: pwsh
        run: |
          $version = "${{ inputs.version }}".Trim().TrimStart("v")
          if ([string]::IsNullOrWhiteSpace($version)) {
            throw "Version input cannot be empty"
          }
          $tag = "v$version"
          "version=$version" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          "tag=$tag" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          Write-Host "Resolved version: $version"

      - name: Stamp legacy app version for this build
        shell: pwsh
        env:
          VERSION: ${{ steps.meta.outputs.version }}
        run: |
          $cargoPath = "swifttunnel-windows/Cargo.toml"
          $content = Get-Content $cargoPath -Raw
          $updated = [regex]::Replace($content, '(?m)^(version\s*=\s*")([^"]+)(")', {
            param($m)
            return "$($m.Groups[1].Value)$env:VERSION$($m.Groups[3].Value)"
          }, 1)
          if ($updated -eq $content) {
            throw "Failed to update swifttunnel-windows/Cargo.toml version"
          }
          Set-Content -Path $cargoPath -Value $updated -Encoding utf8
          Select-String -Path $cargoPath -Pattern '^version\s*='

      - name: Prepare packaging assets
        shell: pwsh
        run: |
          $projectRoot = "swifttunnel-windows"
          $distDir = Join-Path $projectRoot "dist"
          New-Item -ItemType Directory -Path $distDir -Force | Out-Null

          $iconCandidates = @(
            (Join-Path $projectRoot "dist\swifttunnel.ico"),
            (Join-Path $projectRoot "assets\swifttunnel.ico"),
            (Join-Path $projectRoot "installer\swifttunnel.ico")
          )
          $iconSource = $iconCandidates | Where-Object { Test-Path $_ } | Select-Object -First 1
          if (-not $iconSource) {
            throw "Could not find swifttunnel.ico in dist/, assets/, or installer/"
          }
          Copy-Item $iconSource (Join-Path $distDir "swifttunnel.ico") -Force

          $wintunTarget = Join-Path $distDir "wintun.dll"
          if (-not (Test-Path $wintunTarget)) {
            $wintunSource = Join-Path $projectRoot "drivers\wintun.dll"
            if (-not (Test-Path $wintunSource)) {
              throw "wintun.dll missing from dist/ and drivers/"
            }
            Copy-Item $wintunSource $wintunTarget -Force
          }

      - name: Build legacy binary
        shell: pwsh
        run: |
          cargo build --release --target x86_64-pc-windows-msvc -p swifttunnel-fps-booster --bin swifttunnel-fps-booster

      - name: Package with Velopack
        id: pack
        shell: pwsh
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION: ${{ steps.meta.outputs.version }}
        run: |
          $releaseDir = "target\x86_64-pc-windows-msvc\release"
          $stagingDir = Join-Path $env:RUNNER_TEMP "velopack_staging"
          $outputDir = Join-Path $env:RUNNER_TEMP "velopack_output"

          if (Test-Path $stagingDir) { Remove-Item $stagingDir -Recurse -Force }
          if (Test-Path $outputDir) { Remove-Item $outputDir -Recurse -Force }
          New-Item -ItemType Directory -Path $stagingDir | Out-Null
          New-Item -ItemType Directory -Path (Join-Path $stagingDir "drivers") | Out-Null
          New-Item -ItemType Directory -Path $outputDir | Out-Null

          Copy-Item (Join-Path $releaseDir "swifttunnel-fps-booster.exe") (Join-Path $stagingDir "swifttunnel-fps-booster.exe") -Force
          Copy-Item "swifttunnel-windows\dist\wintun.dll" (Join-Path $stagingDir "wintun.dll") -Force

          $driverSourceDir = Join-Path $env:RUNNER_TEMP "ndisapi_driver"
          if (Test-Path $driverSourceDir) { Remove-Item $driverSourceDir -Recurse -Force }
          New-Item -ItemType Directory -Path $driverSourceDir | Out-Null

          $downloadedMsi = Join-Path $driverSourceDir "Windows.Packet.Filter.3.6.2.1.x64.msi"
          $downloaded = $false
          for ($attempt = 1; $attempt -le 5; $attempt++) {
            Write-Host "Downloading WinpkFilter MSI (attempt $attempt/5)..."
            gh release download v3.6.2 `
              --repo wiresock/ndisapi `
              --pattern "Windows.Packet.Filter.3.6.2.1.x64.msi" `
              --dir $driverSourceDir `
              --clobber
            if (Test-Path $downloadedMsi) {
              $downloaded = $true
              break
            }
            Start-Sleep -Seconds (5 * $attempt)
          }
          if (-not $downloaded) {
            throw "Failed to download Windows.Packet.Filter.3.6.2.1.x64.msi after retries"
          }

          $driverMsi = Join-Path $stagingDir "drivers\WinpkFilter-x64.msi"
          Copy-Item $downloadedMsi $driverMsi -Force
          $driverSize = (Get-Item $driverMsi).Length
          if ($driverSize -lt 500000) {
            throw "Downloaded WinpkFilter-x64.msi is suspiciously small ($driverSize bytes)"
          }

          vpk pack `
            -u SwiftTunnel `
            -v $env:VERSION `
            -p $stagingDir `
            -e swifttunnel-fps-booster.exe `
            --icon "swifttunnel-windows\dist\swifttunnel.ico" `
            -o $outputDir

          Write-Host "Generated compatibility assets:"
          Get-ChildItem $outputDir -File | ForEach-Object { Write-Host "  $($_.Name)" }
          "output_dir=$outputDir" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

      - name: Ensure release exists
        shell: pwsh
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ steps.meta.outputs.tag }}
          VERSION: ${{ steps.meta.outputs.version }}
        run: |
          gh release view $env:TAG --repo $env:GITHUB_REPOSITORY *> $null
          if ($LASTEXITCODE -ne 0) {
            gh release create $env:TAG `
              --repo $env:GITHUB_REPOSITORY `
              --title "SwiftTunnel v$env:VERSION" `
              --notes "Compatibility release assets for legacy updater." `
              --latest
          } else {
            Write-Host "Release $env:TAG already exists, uploading compatibility assets."
          }

      - name: Upload compatibility assets
        shell: pwsh
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ steps.meta.outputs.tag }}
          OUTPUT_DIR: ${{ steps.pack.outputs.output_dir }}
        run: |
          $files = Get-ChildItem $env:OUTPUT_DIR -File | ForEach-Object { $_.FullName }
          if (-not $files -or $files.Count -eq 0) {
            throw "No compatibility assets found in $env:OUTPUT_DIR"
          }
          gh release upload $env:TAG $files --clobber --repo $env:GITHUB_REPOSITORY
